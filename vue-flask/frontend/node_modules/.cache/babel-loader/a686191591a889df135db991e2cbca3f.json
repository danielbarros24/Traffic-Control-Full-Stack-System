{"ast":null,"code":"//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\nimport ReteEditor from \"@/components/rete/ReteEditor\";\nimport * as dayjs from \"dayjs\";\nexport default {\n  name: \"Automations\",\n  components: {\n    ReteEditor\n  },\n\n  data() {\n    return {\n      gpios: [],\n      value: null,\n      items: [{\n        title: \"Logout\",\n        icon: \"mdi-logout\",\n\n        click() {\n          this.$router.push(\"/\");\n        }\n\n      }, {\n        title: \"Dashboard\",\n        icon: \"mdi-view-dashboard\",\n\n        click() {\n          this.$router.push(\"dashboard\");\n        }\n\n      }, {\n        title: \"Settings\",\n        icon: \"mdi-cogs\",\n\n        click() {\n          this.$router.push(\"settings\");\n        }\n\n      }],\n      menuStart: false,\n      menuEnd: false,\n      menu1: null,\n      menu2: null,\n      switch1: false,\n      AutomationName: \"\",\n      dialog: false,\n      rule_dialog: false,\n      dialogDelete: false,\n      headers: [{\n        text: \"\",\n        value: \"enable\",\n        sortable: false,\n        width: 0\n      }, {\n        text: \"Name\",\n        align: \"start\",\n        value: \"name\"\n      }, {\n        text: \"Actions\",\n        value: \"actions\",\n        sortable: false\n      }],\n      automations: [],\n      editedIndex: -1,\n      editedItem: {\n        id: 0,\n        name: \"\",\n        rule: 0,\n        gpios: [],\n        enable: false,\n        dates: [],\n        startHour: \"\",\n        endHour: \"\",\n        blueprint: {}\n      },\n      defaultItem: {\n        id: 0,\n        name: \"\",\n        rule: 0,\n        gpios: [],\n        enable: false,\n        dates: [],\n        startHour: \"\",\n        endHour: \"\",\n        blueprint: {}\n      },\n      editor: null,\n      editorJSON: \"\",\n      notValidated: false,\n      incorrectConfig: false,\n      correctConfig: false,\n      canSave: false\n    };\n  },\n\n  computed: {\n    formTitle() {\n      return this.editedIndex === -1 ? \"New Process\" : \"Edit Processes\";\n    },\n\n    dateRangeText() {\n      return this.editedItem.dates.join(\" ~ \");\n    },\n\n    allGpios() {\n      if (this.editedIndex < 0) {\n        return this.gpios.sort((a, b) => a.value - b.value);\n      }\n\n      return this.gpios.concat(this.automations[this.editedIndex].gpios.map(value => ({\n        text: `GPIO ${value}`,\n        value: value\n      }))).sort((a, b) => a.value - b.value);\n    },\n\n    orderEditedGpios: {\n      get() {\n        return this.editedItem.gpios.sort((a, b) => a - b);\n      },\n\n      set(value) {\n        this.editedItem.gpios = value;\n      }\n\n    }\n  },\n  watch: {\n    dialog(val) {\n      val || this.close();\n    },\n\n    dialogDelete(val) {\n      val || this.closeDelete();\n    }\n\n  },\n\n  async mounted() {\n    const responseAutomations = await fetch(\"http://127.0.0.1:5000/automation\");\n    const jsonAutomations = await responseAutomations.json();\n    this.automations = jsonAutomations.map(val => {\n      const startTime = new Date(val.startTime);\n      const endTime = new Date(val.endTime);\n      delete val.startTime;\n      delete val.endTime;\n      val.dates = [`${dayjs(startTime).format(\"YYYY-MM-DD\")}`, `${dayjs(endTime).format(\"YYYY-MM-DD\")}`];\n      val.startHour = `${dayjs(startTime).format(\"HH:mm\")}`;\n      val.endHour = `${dayjs(endTime).format(\"HH:mm\")}`;\n      return val;\n    });\n    this.getPins();\n  },\n\n  methods: {\n    async createNodeClick() {},\n\n    handleClick(index) {\n      this.items[index].click.call(this);\n    },\n\n    clickLogo() {\n      this.$router.push(\"dashboard\");\n    },\n\n    async getPins() {\n      const responseGpios = await fetch(\"http://127.0.0.1:5000/pins\");\n      const jsonGpios = await responseGpios.json();\n      this.gpios = jsonGpios.map(value => ({\n        text: `GPIO ${value}`,\n        value: value\n      }));\n    },\n\n    async editItem(item) {\n      this.editedIndex = this.automations.indexOf(item);\n      this.editedItem = Object.assign({}, item);\n      this.dialog = true;\n      setTimeout(async () => {\n        const blueprint = this.editedItem.blueprint;\n        await this.editor.fromJSON(blueprint);\n      }, 200);\n    },\n\n    async createItem() {\n      this.dialog = true;\n      setTimeout(async () => {\n        await this.editor.clear();\n      }, 200);\n    },\n\n    deleteItem(item) {\n      this.editedIndex = this.automations.indexOf(item);\n      this.editedItem = Object.assign({}, item);\n      this.dialogDelete = true;\n    },\n\n    async deleteItemConfirm() {\n      const id = this.editedItem.id;\n      await fetch(`http://127.0.0.1:5000/automation?id=${id}`, {\n        method: \"DELETE\"\n      });\n      this.automations.splice(this.editedIndex, 1);\n      this.closeDelete();\n    },\n\n    close() {\n      this.dialog = false;\n      this.$nextTick(() => {\n        this.editedItem = Object.assign({}, this.defaultItem);\n        this.editedIndex = -1;\n      });\n      this.correctConfig = false;\n      this.incorrectConfig = false;\n      this.notValidated = false;\n      this.canSave = false;\n    },\n\n    closeDelete() {\n      this.dialogDelete = false;\n      this.$nextTick(() => {\n        this.editedItem = Object.assign({}, this.defaultItem);\n        this.editedIndex = -1;\n      });\n    },\n\n    async save() {\n      if (this.canSave == true) {\n        const editor = this.editor;\n        const blueprint = await editor.toJSON();\n        const endNode = this.editor.nodes.find(node => node.name === \"End\");\n        const endComponent = editor.getComponent(\"End\");\n        const logic = endComponent.toJsonLogic?.(endNode);\n        const dates = this.editedItem.dates;\n        const startHour = this.editedItem.startHour;\n        const endHour = this.editedItem.endHour;\n        const startTime = dayjs(dates[0] + \" \" + startHour).toISOString();\n        const endTime = dayjs(dates[1] + \" \" + endHour).toISOString();\n        const automation = {\n          name: this.editedItem.name,\n          startTime: startTime,\n          endTime: endTime,\n          enable: this.editedItem.enable,\n          gpios: this.editedItem.gpios,\n          rules: logic,\n          blueprint: blueprint\n        };\n        const file = JSON.stringify(automation);\n\n        if (this.editedIndex > -1) {\n          const id = this.editedItem.id;\n          await fetch(`http://127.0.0.1:5000/automation?id=${id}`, {\n            method: \"PATCH\",\n            headers: {\n              \"Content-Type\": \"application/json\"\n            },\n            body: file\n          });\n          Object.assign(this.automations[this.editedIndex], this.editedItem);\n        } else {\n          await fetch(\"http://127.0.0.1:5000/automation\", {\n            method: \"POST\",\n            headers: {\n              \"Content-Type\": \"application/json\"\n            },\n            body: file\n          });\n          this.automations.push(this.editedItem);\n        }\n\n        this.close();\n      } else {\n        this.notValidated = true;\n      }\n    },\n\n    async updateEnable(event, item) {\n      const id = item.id;\n      await fetch(`http://127.0.0.1:5000/automation?id=${id}`, {\n        method: \"PATCH\",\n        headers: {\n          \"Content-Type\": \"application/json\"\n        },\n        body: JSON.stringify({\n          enable: !!event\n        })\n      });\n    },\n\n    async onValidate() {\n      const editor = this.editor;\n      const endNode = this.editor.nodes.find(node => node.name === \"End\");\n      const endComponent = editor.getComponent(\"End\");\n\n      if (this.editedItem.name != \"\" && this.editedItem.gpios != [] && this.editedItem.startHour != \"\" && this.editedItem.endHour != \"\" && this.editedItem.dates != [] && endNode != null) {\n        //console.log(JSON.stringify(endComponent.toJsonLogic?.(endNode)));\n        this.incorrectConfig = false;\n        this.correctConfig = true;\n        this.notValidated = false;\n        this.canSave = true;\n      } else {\n        this.incorrectConfig = true;\n        this.correctConfig = false;\n      } //this.$refs.form.validate();\n\n    }\n    /*async onEditorImport() {\n      await this.editor.fromJSON(JSON.parse(this.editorJSON));\n    },\n     async onEditorSync() {\n      this.editorJSON = JSON.stringify(await this.editor.toJSON());\n    },*/\n\n\n  }\n};","map":{"version":3,"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAsQA;AACA;AAEA;AACAA,qBADA;AAEAC;AACAC;AADA,GAFA;;AAMAC;AACA;AACAC,eADA;AAEAC,iBAFA;AAIAC,cACA;AACAC,uBADA;AAEAC,0BAFA;;AAGAC;AACA;AACA;;AALA,OADA,EAQA;AACAF,0BADA;AAEAC,kCAFA;;AAGAC;AACA;AACA;;AALA,OARA,EAeA;AACAF,yBADA;AAEAC,wBAFA;;AAGAC;AACA;AACA;;AALA,OAfA,CAJA;AA4BAC,sBA5BA;AA6BAC,oBA7BA;AA8BAC,iBA9BA;AA+BAC,iBA/BA;AAiCAC,oBAjCA;AAmCAC,wBAnCA;AAoCAC,mBApCA;AAqCAC,wBArCA;AAsCAC,yBAtCA;AAwCAC,gBACA;AACAC,gBADA;AAEAf,uBAFA;AAGAgB,uBAHA;AAIAC;AAJA,OADA,EAOA;AACAF,oBADA;AAEAG,sBAFA;AAGAlB;AAHA,OAPA,EAYA;AAAAe;AAAAf;AAAAgB;AAAA,OAZA,CAxCA;AAsDAG,qBAtDA;AAuDAC,qBAvDA;AAwDAC;AACAC,aADA;AAEA3B,gBAFA;AAGA4B,eAHA;AAIAxB,iBAJA;AAKAyB,qBALA;AAMAC,iBANA;AAOAC,qBAPA;AAQAC,mBARA;AASAC;AATA,OAxDA;AAoEAC;AACAP,aADA;AAEA3B,gBAFA;AAGA4B,eAHA;AAIAxB,iBAJA;AAKAyB,qBALA;AAMAC,iBANA;AAOAC,qBAPA;AAQAC,mBARA;AASAC;AATA,OApEA;AAgFAE,kBAhFA;AAiFAC,oBAjFA;AAmFAC,yBAnFA;AAoFAC,4BApFA;AAqFAC,0BArFA;AAsFAC;AAtFA;AAwFA,GA/FA;;AAiGAC;AACAC;AACA;AACA,KAHA;;AAIAC;AACA;AACA,KANA;;AAOAC;AACA;AACA;AACA;;AACA,wBACAC,MADA,CAEA;AACAzB,6BADA;AAEAf;AAFA,SAFA,EAOAyC,IAPA,CAOA,2BAPA;AAQA,KAnBA;;AAoBAC;AACAC;AACA;AACA,OAHA;;AAIAC;AACA;AACA;;AANA;AApBA,GAjGA;AA+HAC;AACAlC;AACAmC;AACA,KAHA;;AAIAjC;AACAiC;AACA;;AANA,GA/HA;;AAwIA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AAEAA,mBACA,0CADA,EAEA,wCAFA;AAIAA;AACAA;AAEA;AACA,KAfA;AAiBA;AACA,GA7JA;;AA+JAC;AACA,8BADA;;AAEAC;AACA;AACA,KAJA;;AAKAC;AACA;AACA,KAPA;;AASA;AACA;AACA;AAEA;AACAlC,6BADA;AAEAf;AAFA;AAIA,KAjBA;;AAmBA;AACA;AACA;AAEA;AAEAkD;AACA;AACA;AACA,OAHA,EAGA,GAHA;AAIA,KA7BA;;AA+BA;AACA;AACAA;AACA;AACA,OAFA,EAEA,GAFA;AAGA,KApCA;;AAsCAC;AACA;AACA;AACA;AACA,KA1CA;;AA4CA;AACA;AACA;AACAC;AADA;AAGA;AACA;AACA,KAnDA;;AAqDAC;AACA;AACA;AACA;AACA;AACA,OAHA;AAIA;AACA;AACA;AACA;AACA,KA/DA;;AAiEAC;AACA;AACA;AACA;AACA;AACA,OAHA;AAKA,KAxEA;;AA0EA;AACA;AACA;AAEA;AAEA;AACA;AAEA;AAEA;AAEA;AACA;AAEA;AACA;AAGA;AACA3D,oCADA;AAEA4D,8BAFA;AAGAC,0BAHA;AAIAhC,wCAJA;AAKAzB,sCALA;AAMA0D,sBANA;AAOA7B;AAPA;AAUA;;AAEA;AACA;AACA;AACAwB,2BADA;AAEAtC;AAAA;AAAA,aAFA;AAGA4C;AAHA;AAKAC;AACA,SARA,MAQA;AACA;AACAP,0BADA;AAEAtC;AAAA;AAAA,aAFA;AAGA4C;AAHA;AAKA;AACA;;AAEA;AACA,OAjDA,MAmDA;AACA;AACA;AAEA,KAlIA;;AAoIA;AACA;AAEA;AACAN,uBADA;AAEAtC;AAAA;AAAA,SAFA;AAGA4C;AACAlC;AADA;AAHA;AAOA,KA9IA;;AAgJA;AACA;AAEA;AACA;;AAEA,UACA,8BACA,2BADA,IAEA,+BAFA,IAGA,6BAHA,IAIA,2BAJA,IAKAoC,eANA,EAOA;AACA;AACA;AACA;AACA;AACA;AAEA,OAdA,MAcA;AACA;AACA;AACA,OAvBA,CAwBA;;AACA;AAEA;AACA;AACA;;AAEA;AACA;;;AAhLA;AA/JA","names":["name","components","ReteEditor","data","gpios","value","items","title","icon","click","menuStart","menuEnd","menu1","menu2","switch1","AutomationName","dialog","rule_dialog","dialogDelete","headers","text","sortable","width","align","automations","editedIndex","editedItem","id","rule","enable","dates","startHour","endHour","blueprint","defaultItem","editor","editorJSON","notValidated","incorrectConfig","correctConfig","canSave","computed","formTitle","dateRangeText","allGpios","concat","sort","orderEditedGpios","get","set","watch","val","methods","handleClick","clickLogo","setTimeout","deleteItem","method","close","closeDelete","startTime","endTime","rules","body","Object","endNode"],"sourceRoot":"src/views","sources":["Processes.vue"],"sourcesContent":["<template>\n  <div>\n    <v-app-bar color=\"transparent\" dark elevation=\"0\">\n      <v-img\n        max-height=\"35\"\n        max-width=\"35\"\n        src=\"../assets/logo_simple.png\"\n        @click=\"clickLogo()\"\n      ></v-img>\n      <v-toolbar-title class=\"ml-4\">Processes</v-toolbar-title>\n\n      <v-spacer></v-spacer>\n\n      <v-menu transition=\"slide-y-transition\" offset-y>\n        <template v-slot:activator=\"{ on, attrs }\">\n          <v-btn icon v-bind=\"attrs\" v-on=\"on\">\n            <v-icon>mdi-account</v-icon>\n          </v-btn>\n        </template>\n\n        <v-list>\n          <v-list-item\n            v-for=\"(item, index) in items\"\n            :key=\"index\"\n            @click=\"handleClick(index)\"\n          >\n            <v-list-item-icon>\n              <v-icon v-text=\"item.icon\"></v-icon>\n            </v-list-item-icon>\n            <v-list-item-title>{{ item.title }}</v-list-item-title>\n          </v-list-item>\n        </v-list>\n      </v-menu>\n    </v-app-bar>\n\n    <v-data-table\n      :headers=\"headers\"\n      :items=\"automations\"\n      class=\"elevation-24 mt-13\"\n    >\n      <template v-slot:top>\n        <v-toolbar flat>\n          <v-toolbar-title class=\"font-weight-bold\">Processes</v-toolbar-title>\n          <v-spacer></v-spacer>\n          <v-btn\n            color=\"primary\"\n            depressed\n            elevation=\"4\"\n            raised\n            mx-auto\n            rounded\n            dark\n            @click=\"\n              createItem();\n              getPins();\n            \"\n          >\n            <v-icon class=\"mr-3\">mdi-plus</v-icon>Create process\n          </v-btn>\n          <v-dialog v-model=\"dialog\" full-screen>\n            <v-card overflow-hidden>\n              <v-card-title>\n                <span class=\"text-h4 font-weight-bold\">{{ formTitle }}</span>\n              </v-card-title>\n              <v-card-actions>\n                <v-btn color=\"primary\" text @click=\"save\"> Save </v-btn>\n                <v-btn color=\"primary\" text @click=\"close\"> Cancel </v-btn>\n              </v-card-actions>\n              <v-card-text v-show=\"notValidated\" class=\"red--text\">Validate process configuration!</v-card-text>\n              <v-card-text>\n                <v-row>\n                  <v-col cols=\"4\" md=\"2\">\n                    <h2 class=\"mt-8\">Name</h2>\n                    <v-text-field\n                      v-model=\"editedItem.name\"\n                      label=\"Insert process Name Here!\"\n                      class=\"mt-3 mb-6\"\n                      required\n                    ></v-text-field>\n\n                    <div>\n                      <h2>Time</h2>\n                      <v-menu\n                        v-model=\"menu2\"\n                        :close-on-content-click=\"false\"\n                        :nudge-right=\"40\"\n                        transition=\"scale-transition\"\n                        offset-y\n                        min-width=\"auto\"\n                      >\n                        <template v-slot:activator=\"{ on, attrs }\">\n                          <v-text-field\n                            v-model=\"dateRangeText\"\n                            label=\"Select date range\"\n                            prepend-icon=\"mdi-calendar\"\n                            readonly\n                            v-bind=\"attrs\"\n                            v-on=\"on\"\n                            class=\"mt-3\"\n                            required\n                          ></v-text-field>\n                        </template>\n                        <v-date-picker\n                          v-model=\"editedItem.dates\"\n                          range\n                        ></v-date-picker>\n                      </v-menu>\n\n                      <v-menu\n                        ref=\"menu1\"\n                        v-model=\"menuStart\"\n                        :close-on-content-click=\"false\"\n                        :nudge-right=\"40\"\n                        :return-value.sync=\"editedItem.startHour\"\n                        transition=\"scale-transition\"\n                        offset-y\n                        max-width=\"290px\"\n                        min-width=\"290px\"\n                      >\n                        <template v-slot:activator=\"{ on, attrs }\">\n                          <v-text-field\n                            v-model=\"editedItem.startHour\"\n                            label=\"Start Time\"\n                            prepend-icon=\"mdi-clock-time-four-outline\"\n                            readonly\n                            v-bind=\"attrs\"\n                            v-on=\"on\"\n                            required\n                          ></v-text-field>\n                        </template>\n                        <v-time-picker\n                          v-if=\"menuStart\"\n                          v-model=\"editedItem.startHour\"\n                          format=\"24h\"\n                          scrollable\n                          full-width\n                          @click:minute=\"$refs.menu1.save(editedItem.startHour)\"\n                        ></v-time-picker>\n                      </v-menu>\n\n                      <v-menu\n                        ref=\"menu2\"\n                        v-model=\"menuEnd\"\n                        :close-on-content-click=\"false\"\n                        :nudge-right=\"40\"\n                        :return-value.sync=\"editedItem.endHour\"\n                        transition=\"scale-transition\"\n                        offset-y\n                        max-width=\"290px\"\n                        min-width=\"290px\"\n                      >\n                        <template v-slot:activator=\"{ on, attrs }\">\n                          <v-text-field\n                            v-model=\"editedItem.endHour\"\n                            label=\"End Time\"\n                            prepend-icon=\"mdi-clock-time-four-outline\"\n                            readonly\n                            v-bind=\"attrs\"\n                            v-on=\"on\"\n                            class=\"mb-6\"\n                            required\n                          ></v-text-field>\n                        </template>\n                        <v-time-picker\n                          v-if=\"menuEnd\"\n                          v-model=\"editedItem.endHour\"\n                          format=\"24h\"\n                          scrollable\n                          full-width\n                          @click:minute=\"$refs.menu2.save(editedItem.endHour)\"\n                        ></v-time-picker>\n                      </v-menu>\n                    </div>\n\n                    <div>\n                      <h2>Outputs</h2>\n                      <v-row>\n                        <v-autocomplete\n                          v-model=\"orderEditedGpios\"\n                          :items=\"allGpios\"\n                          chips\n                          deletable-chips\n                          multiple\n                          label=\"Select GPIOS as outputs\"\n                          class=\"ml-3 mt-3 mb-6\"\n                          required\n                        >\n                          <template v-slot:item=\"{ item, on, attrs }\">\n                            <v-list-item v-on=\"on\" v-bind=\"attrs\">\n                              <v-list-item-content>\n                                <v-list-item-title>\n                                  <v-chip dark color=\"primary\">\n                                    {{ item.text }}\n                                  </v-chip>\n                                </v-list-item-title>\n                              </v-list-item-content>\n                            </v-list-item>\n                          </template>\n                        </v-autocomplete>\n                      </v-row>\n                    </div>\n\n                    <div>\n                      <h2>Enable</h2>\n                      <v-switch\n                        color=\"primary\"\n                        v-model=\"editedItem.enable\"\n                      ></v-switch>\n                    </div>\n\n                    <v-btn @click=\"onValidate\" \n                      >Validate</v-btn\n                    >\n                    <p v-show=\"incorrectConfig\" class=\"red--text mt-3\">Incorrect configuration!</p>\n                     <p v-show=\"correctConfig\" class=\"green--text mt-3\">Correct configuration!</p>\n                    <!-- <v-textarea v-model=\"editorJSON\"></v-textarea> -->\n                    <!-- <v-btn @click=\"onEditorSync\">Sync</v-btn> -->\n                    <!-- <v-btn @click=\"onEditorImport\">Import</v-btn> -->\n                  </v-col>\n                  <v-col md=\"10\">\n                    <ReteEditor v-model=\"editor\" />\n                  </v-col>\n                </v-row>\n              </v-card-text>\n            </v-card>\n          </v-dialog>\n\n          <v-dialog v-model=\"dialogDelete\" max-width=\"573px\">\n            <v-card>\n              <v-card-title class=\"text-h5\"\n                >Are you sure you want to delete this processs?</v-card-title\n              >\n              <v-card-actions>\n                <v-spacer></v-spacer>\n                <v-btn color=\"primary\" text @click=\"closeDelete\">Cancel</v-btn>\n                <v-btn color=\"primary\" text @click=\"deleteItemConfirm\"\n                  >OK</v-btn\n                >\n                <v-spacer></v-spacer>\n              </v-card-actions>\n            </v-card>\n          </v-dialog>\n        </v-toolbar>\n      </template>\n      <template v-slot:[`item.enable`]=\"{ item }\">\n        <v-switch\n          :input-value=\"item.enable\"\n          @change=\"updateEnable($event, item)\"\n          hide-details\n          class=\"ma-0 pa-0\"\n          color=\"primary\"\n        ></v-switch>\n      </template>\n      <template v-slot:[`item.actions`]=\"{ item }\">\n        <v-icon small class=\"mr-2\" @click=\"editItem(item)\"> mdi-pencil </v-icon>\n        <v-icon small @click=\"deleteItem(item)\"> mdi-delete </v-icon>\n      </template>\n    </v-data-table>\n  </div>\n</template>\n\n<script>\nimport ReteEditor from \"@/components/rete/ReteEditor\";\nimport * as dayjs from \"dayjs\";\n\nexport default {\n  name: \"Automations\",\n  components: {\n    ReteEditor,\n  },\n\n  data() {\n    return {\n      gpios: [],\n      value: null,\n\n      items: [\n        {\n          title: \"Logout\",\n          icon: \"mdi-logout\",\n          click() {\n            this.$router.push(\"/\");\n          },\n        },\n        {\n          title: \"Dashboard\",\n          icon: \"mdi-view-dashboard\",\n          click() {\n            this.$router.push(\"dashboard\");\n          },\n        },\n        {\n          title: \"Settings\",\n          icon: \"mdi-cogs\",\n          click() {\n            this.$router.push(\"settings\");\n          },\n        },\n      ],\n\n      menuStart: false,\n      menuEnd: false,\n      menu1: null,\n      menu2: null,\n\n      switch1: false,\n\n      AutomationName: \"\",\n      dialog: false,\n      rule_dialog: false,\n      dialogDelete: false,\n\n      headers: [\n        {\n          text: \"\",\n          value: \"enable\",\n          sortable: false,\n          width: 0,\n        },\n        {\n          text: \"Name\",\n          align: \"start\",\n          value: \"name\",\n        },\n        { text: \"Actions\", value: \"actions\", sortable: false },\n      ],\n      automations: [],\n      editedIndex: -1,\n      editedItem: {\n        id: 0,\n        name: \"\",\n        rule: 0,\n        gpios: [],\n        enable: false,\n        dates: [],\n        startHour: \"\",\n        endHour: \"\",\n        blueprint: {},\n      },\n\n      defaultItem: {\n        id: 0,\n        name: \"\",\n        rule: 0,\n        gpios: [],\n        enable: false,\n        dates: [],\n        startHour: \"\",\n        endHour: \"\",\n        blueprint: {},\n      },\n\n      editor: null,\n      editorJSON: \"\",\n\n      notValidated: false,\n      incorrectConfig: false,\n      correctConfig: false,\n      canSave: false,\n    };\n  },\n\n  computed: {\n    formTitle() {\n      return this.editedIndex === -1 ? \"New Process\" : \"Edit Processes\";\n    },\n    dateRangeText() {\n      return this.editedItem.dates.join(\" ~ \");\n    },\n    allGpios() {\n      if (this.editedIndex < 0) {\n        return this.gpios.sort((a, b) => a.value - b.value);\n      }\n      return this.gpios\n        .concat(\n          this.automations[this.editedIndex].gpios.map((value) => ({\n            text: `GPIO ${value}`,\n            value: value,\n          }))\n        )\n        .sort((a, b) => a.value - b.value);\n    },\n    orderEditedGpios: {\n      get() {\n        return this.editedItem.gpios.sort((a, b) => a - b);\n      },\n      set(value) {\n        this.editedItem.gpios = value;\n      },\n    },\n  },\n\n  watch: {\n    dialog(val) {\n      val || this.close();\n    },\n    dialogDelete(val) {\n      val || this.closeDelete();\n    },\n  },\n\n  async mounted() {\n    const responseAutomations = await fetch(\"http://127.0.0.1:5000/automation\");\n    const jsonAutomations = await responseAutomations.json();\n    this.automations = jsonAutomations.map((val) => {\n      const startTime = new Date(val.startTime);\n      const endTime = new Date(val.endTime);\n\n      delete val.startTime;\n      delete val.endTime;\n\n      val.dates = [\n        `${dayjs(startTime).format(\"YYYY-MM-DD\")}`,\n        `${dayjs(endTime).format(\"YYYY-MM-DD\")}`,\n      ];\n      val.startHour = `${dayjs(startTime).format(\"HH:mm\")}`;\n      val.endHour = `${dayjs(endTime).format(\"HH:mm\")}`;\n\n      return val;\n    });\n\n    this.getPins();\n  },\n\n  methods: {\n    async createNodeClick() {},\n    handleClick(index) {\n      this.items[index].click.call(this);\n    },\n    clickLogo() {\n      this.$router.push(\"dashboard\");\n    },\n\n    async getPins() {\n      const responseGpios = await fetch(\"http://127.0.0.1:5000/pins\");\n      const jsonGpios = await responseGpios.json();\n\n      this.gpios = jsonGpios.map((value) => ({\n        text: `GPIO ${value}`,\n        value: value,\n      }));\n    },\n\n    async editItem(item) {\n      this.editedIndex = this.automations.indexOf(item);\n      this.editedItem = Object.assign({}, item);\n\n      this.dialog = true;\n\n      setTimeout(async () => {\n        const blueprint = this.editedItem.blueprint;\n        await this.editor.fromJSON(blueprint);\n      }, 200);\n    },\n\n    async createItem() {\n      this.dialog = true;\n      setTimeout(async () => {\n        await this.editor.clear();\n      }, 200);\n    },\n\n    deleteItem(item) {\n      this.editedIndex = this.automations.indexOf(item);\n      this.editedItem = Object.assign({}, item);\n      this.dialogDelete = true;\n    },\n\n    async deleteItemConfirm() {\n      const id = this.editedItem.id;\n      await fetch(`http://127.0.0.1:5000/automation?id=${id}`, {\n        method: \"DELETE\",\n      });\n      this.automations.splice(this.editedIndex, 1);\n      this.closeDelete();\n    },\n\n    close() {\n      this.dialog = false;\n      this.$nextTick(() => {\n        this.editedItem = Object.assign({}, this.defaultItem);\n        this.editedIndex = -1;\n      });\n      this.correctConfig = false\n      this.incorrectConfig = false\n      this.notValidated = false\n      this.canSave = false\n    },\n\n    closeDelete() {\n      this.dialogDelete = false;\n      this.$nextTick(() => {\n        this.editedItem = Object.assign({}, this.defaultItem);\n        this.editedIndex = -1;\n      });\n      \n    },\n\n    async save() {\n      if(this.canSave == true) {\n        const editor = this.editor;\n\n        const blueprint = await editor.toJSON();\n\n        const endNode = this.editor.nodes.find((node) => node.name === \"End\");\n        const endComponent = editor.getComponent(\"End\");\n\n        const logic = endComponent.toJsonLogic?.(endNode);\n\n        const dates = this.editedItem.dates;\n\n        const startHour = this.editedItem.startHour;\n        const endHour = this.editedItem.endHour;\n\n        const startTime = dayjs(dates[0] + \" \" + startHour).toISOString();\n        const endTime = dayjs(dates[1] + \" \" + endHour).toISOString();\n\n\n        const automation = {\n          name: this.editedItem.name,\n          startTime: startTime,\n          endTime: endTime,\n          enable: this.editedItem.enable,\n          gpios: this.editedItem.gpios,\n          rules: logic,\n          blueprint: blueprint,\n        };\n\n        const file = JSON.stringify(automation);\n\n        if (this.editedIndex > -1) {\n          const id = this.editedItem.id;\n          await fetch(`http://127.0.0.1:5000/automation?id=${id}`, {\n            method: \"PATCH\",\n            headers: { \"Content-Type\": \"application/json\" },\n            body: file,\n          });\n          Object.assign(this.automations[this.editedIndex], this.editedItem);\n        } else {\n          await fetch(\"http://127.0.0.1:5000/automation\", {\n            method: \"POST\",\n            headers: { \"Content-Type\": \"application/json\" },\n            body: file,\n          });\n          this.automations.push(this.editedItem);\n        }\n\n          this.close();\n      }\n      \n      else {\n          this.notValidated = true\n      }\n      \n    },\n\n    async updateEnable(event, item) {\n      const id = item.id;\n\n      await fetch(`http://127.0.0.1:5000/automation?id=${id}`, {\n        method: \"PATCH\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify({\n          enable: !!event,\n        }),\n      });\n    },\n\n    async onValidate() {\n      const editor = this.editor;\n\n      const endNode = this.editor.nodes.find((node) => node.name === \"End\");\n      const endComponent = editor.getComponent(\"End\");\n\n      if (\n        this.editedItem.name != \"\" &&\n        this.editedItem.gpios != [] &&\n        this.editedItem.startHour != \"\" &&\n        this.editedItem.endHour != \"\" &&\n        this.editedItem.dates != [] &&\n        endNode != null\n      ) {\n        //console.log(JSON.stringify(endComponent.toJsonLogic?.(endNode)));\n        this.incorrectConfig = false\n        this.correctConfig = true\n        this.notValidated = false\n        this.canSave = true\n\n      } else {\n        this.incorrectConfig = true\n        this.correctConfig = false\n      }\n      //this.$refs.form.validate();\n    },\n\n    /*async onEditorImport() {\n      await this.editor.fromJSON(JSON.parse(this.editorJSON));\n    },\n\n    async onEditorSync() {\n      this.editorJSON = JSON.stringify(await this.editor.toJSON());\n    },*/\n  },\n};\n</script>\n"]},"metadata":{},"sourceType":"module"}